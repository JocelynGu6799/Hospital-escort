"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("dtPicker")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../components/dtPicker/dtPicker.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"index",setup(a){const t=getApp(),o=e.ref({});e.onLoad((e=>{console.log("options",e),n(e)}));const l=e.ref([]),i=e.ref(0),s=e.reactive({address:{cityName:"",countyName:"",detailInfo:"",userName:""},demand:"",hospital_id:0,hospital_name:"",receiveAddress:"",service_code:"",service_id:0,service_name:"",service_stype:"",starttime:0,tel:"",client:{age:0,mobile:"",name:"",sex:0},price:0}),n=e=>{t.globalData.utils.myrequest({myurl:"/Service/order",data:{svid:e.svid},mysuccess:a=>{console.log("详情页数据",a),o.value=a.data.service,console.log("service",o.value),l.value=a.data.hospitals,console.log("hospitals",l.value),i.value=l.value.findIndex((a=>a.id==e.hid)),s.price=l.value[i.value].service_price,s.hospital_id=l.value[i.value].id,s.hospital_name=l.value[i.value].name}})},r=e=>{i.value=e.detail.value,s.price=l.value[i.value].service_price,s.hospital_id=l.value[i.value].id,s.hospital_name=l.value[i.value].name},d=e=>{console.log("时间",e),s.starttime=e.detail.value},c=e.reactive({name:"",age:1,mobile:"",sex:0}),u=()=>{e.index.navigateTo({url:"../clients/index?act=select"})};e.index.$on("changeClient",(e=>{c.name=e.name,c.age=e.age,c.mobile=e.mobile,c.sex=e.sex,s.client.name=e.name,s.client.age=e.age,s.client.mobile=e.mobile,s.client.sex=e.sex}));const v=e.reactive({page_xy:"",page_fw:""}),m=e.ref(!1),p=()=>{m.value=!m.value},y=()=>{e.index.chooseAddress({success(e){console.log("成功地址",e),s.address.userName=e.userName,s.address.cityName=e.cityName,s.address.countyName=e.countyName,s.address.detailInfo=e.detailInfo},fail(e){console.log("失败地址",e)}})},g=e.reactive({validCode:"",phone:""}),x=e.reactive({validText:"获取验证码",time:30}),h=e.ref();let _=!0;const f=()=>{if(!1===_)return e.index.showToast({title:"别重复点",icon:"error"});if(!/^(?:(?:\+|00)86)?1\d{10}$/.test(g.phone))return e.index.showToast({title:"手机号不合法",icon:"error"});_=!1,t.globalData.utils.myrequest({myurl:"/get/code",method:"POST",data:{tel:g.phone},mysuccess:a=>{console.log("验证码信息",a),e.index.showToast({title:"验证码已发送,注意查收",duration:1200,icon:"none"})},myfail:a=>(console.log("我的错误提示",a),e.index.showToast({title:"验证码获取失败",icon:"error"}))});let a=setInterval((()=>{x.time<=0?(x.validText="获取验证码",x.time=30,_=!0,clearInterval(a)):(x.validText=`剩余${x.time}秒`,x.time-=1)}),1e3)},T=()=>{h.value.close()},b=()=>{if(!g.phone||!g.validCode)return e.index.showToast({title:"输入不完整",duration:1200,icon:"error"});t.globalData.utils.myrequest({myurl:"/user/authentication",method:"POST",data:{tel:g.phone,code:g.validCode},mysuccess:a=>{console.log("验证码验证信息",a),e.index.showToast({title:a.msg,duration:1200,icon:"none"}),e.index.setStorageSync("token",a.data.token),h.value.close()},myfail:a=>(console.log("我的验证码错误提示",a),e.index.showToast({title:a.data.msg?a.data.msg:"验证码错误",icon:"none"}))})},k=()=>{if(!m.value)return e.index.showToast({title:"请勾选协议",duration:1200,icon:"error"});e.index.getStorageSync("token")?C():h.value.open("center")},w=e.ref(),C=()=>{s.service_code=o.value.code,s.service_id=o.value.id,s.service_name=o.value.name,s.service_stype=o.value.stype,console.log("订单信息",s),t.globalData.utils.myrequest({myurl:"/pay/createOrder",method:"POST",data:s,header:{token:e.index.getStorageSync("token")},mysuccess:a=>{console.log("订单提交信息",a),w.value.open("center");const t=new e.UQRCode;t.data=a.wx_code,t.size=200,t.make();var o=e.index.createCanvasContext("qrcode");t.canvasContext=o,t.drawCanvas()},myfail:a=>(console.log("订单提交错误信息",a),e.index.showToast({title:"订单提交错误",icon:"error"}))})},N=()=>{e.index.switchTab({url:"../myorder/index"})};return(a,t)=>e.e({a:o.value.icon_image?o.value.icon_image_url:"../../static/images/avatar.jpg",b:e.t(o.value.name),c:e.o(((...e)=>a.handleTap&&a.handleTap(...e))),d:10==o.value.stype||15==o.value.stype||20==o.value.stype},10==o.value.stype||15==o.value.stype||20==o.value.stype?e.e({e:l.value[i.value].name,f:e.o(r),g:i.value,h:l.value,i:e.o(d),j:e.p({timestamp:s.starttime,placeholder:"请选择就诊时间"}),k:c.name,l:e.o(u),m:15==o.value.stype},15==o.value.stype?{n:s.receiveAddress,o:e.o((e=>s.receiveAddress=e.detail.value))}:{},{p:s.tel,q:e.o((e=>s.tel=e.detail.value)),r:s.demand,s:e.o((e=>s.demand=e.detail.value))}):{},{t:30==o.value.stype||40==o.value.stype},30==o.value.stype||40==o.value.stype?{v:l.value[i.value].name,w:e.o(r),x:i.value,y:l.value,z:e.o(d),A:e.p({timestamp:s.starttime,placeholder:"请选择期望服务时间"}),B:s.address.userName?s.address.userName+"("+s.address.cityName+s.address.countyName+s.address.detailInfo+")":"",C:e.o(y),D:s.tel,E:e.o((e=>s.tel=e.detail.value)),F:s.demand,G:e.o((e=>s.demand=e.detail.value))}:{},{H:e.n("is_xieyi "+(m.value?"is_xieyi_on":"")),I:e.o(p),J:v.page_xy,K:v.page_fw,L:s.price>0},s.price>0?{M:e.t(s.price)}:{},{N:e.n("btnp "+(m.value?"":"btnp-disabled")),O:e.o(k),P:g.phone,Q:e.o((e=>g.phone=e.detail.value)),R:g.validCode,S:e.o((e=>g.validCode=e.detail.value)),T:e.t(x.validText),U:e.o(f),V:e.o(T),W:e.o(b),X:e.sr(h,"2e42e450-2",{k:"popup"}),Y:e.p({type:"center","is-mask-click":!1,"background-color":"#fff"}),Z:e.o(N),aa:e.sr(w,"2e42e450-3",{k:"qrcodePopup"}),ab:e.p({type:"center","is-mask-click":!1,"background-color":"#fff"})})}};wx.createPage(a);
