"use strict";const e=require("../../../../common/vendor.js"),t=require("../../js_sdk/js_sdk.js"),i=e.Ws.importObject("uni-pay-co");var r;const o={name:"uni-pay",emits:["success","cancel","fail","create","mounted","qrcode"],props:{adpid:{Type:String,default:""},toSuccessPage:{Type:Boolean,default:!0},returnUrl:{Type:String,default:""},mainColor:{Type:String,default:""},mode:{Type:String,default:""},logo:{Type:String,default:"/static/logo.png"},height:{Type:[String],default:"70vh"},debug:{Type:Boolean,default:!1}},data:()=>({options:{},res:{},images:{wxpay:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABC9JREFUeF7tWk1a20AMlUzv0bDr13AAYAOcpLCBcoqQU1DYEE6C2QAHIP26q3sPPOqniU2cZMYj+SeGxN5kEXlm9ObpjaQxwpY/uOX+Qw9Az4AtR6APgS0nQC+CfQi0FQLfrvcHXwAGPP4bQMK/fy5f7O9HehphwPfb/dOIogEhHQHBcamDCDESPoIxMQPTNSi1ABj+OrwDpNMaO5og4P2bMZOugFADwNTewWhU0/FVzAgnKZnxuoFQAbB3vX9MET7U2PHgq4R09vv8ZRI0bMhADMDw9uAhGN8NLQrWyAYRAGt1PgcRIU5TOms7JIIAdOL8nElJauikTRBKAdi7ObwioFFTzHaMw3mBzRV8DwKOXy+ertpagxcAq/YR/g2d6TlNrUDu4EiiE0Why4T1rgyINoXRC4DgjE+mF8+7RYAkp4RrRyVztRUKTgCkuz89fz4pAiB5z7WbklBrKxScAEgWxI6joZPXy5c4B0H0nkPdhzcHFIxxhHgZ8OA7AgMnAMObA479UnF6H5twQpF5RBMdibPDvB4AAAL6IZ0rNbTb9IngAyC8IwJ0K5okQBgzqFEKSV4wcXg17bxl8fIiJXFc0bHAgYLjYlHEFaZlVUQDoAIbcVZaN1VRrgAgUfImASiKW6Yh4pAohmHVQqpLABI0dMYiKhJPCeoV0ueuQsDmEJrkSeJ/bqNJnOqfApqVzWznzrdYWkvzhnUDYGnPKLTdV5gpfLiOqJUIaTefF8RKH6wxtAOX2IdA8NcCmmRItmBLfVF5jRBnR58kGQtWlGUJlBeAxpQ5A4eFKTu/ufLzPQv1f2mRRDiZ/nyyYwYrypI0OlQOc/9PsgshDsh2v+BUwTFnD3K5DglVlD4WlDZEsqywNgiK2F9gQBkLi7EtyV59WhBsiTURCjy5QZMgYRn9cxbZWgCQ+IKlnH2sFQYTURHmCYMgAJaKs9aYPkXNXGK6QhQdt9xeC4UhTC+eV/wVASASmrKj6IMA4NIBMQDsX1VN4IlbuU0K7vmiQS0G5EOpmiW6I1Dpjtp8pYc5yxYVj0RtXcMJcwDFSiqYLh2x+QgqAJwnAuEEydxbkZtdj+fKPVfwbPIq7KngqvMVX4WoAmDBAcH9HTMmXw23s0LJSlPOOsZx0l8VAu/0Fzjuc2Td3aY5zf1VoZgBvPgmvuhoIrFSMSXQThcDoJo0YLxGLfBSv5IINgVC1XxCOb/oZrkTBtRJqkQgKG6ROgPgPbGq/6HVIiYK51WngAj5ikbBhoZi3FALbHmozhlQXFChTc75g6wRM2ufzb9N/IwMcG0wg8HZJf9HBF/tFZnBBBH+cW/BpBDnd4XLDNJcon4oBiiY7jS194mEI0IaSz+12ygAclSYEcXvFsqA3UgANEzqAdCgtYm2PQM2cVc1PvUM0KC1ibY9AzZxVzU+bT0D/gPs/oxfcUEcJAAAAABJRU5ErkJggg==",alipay:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAA2FJREFUeF7tmU122jAQx2cMB2hp9yULeK+naHISwhJyiIRDBJaQkwRO0fdgEWff0h4ANH0yFc+m+hhbckKNvJUsaX76z4ckhAv/8MLthwggKuDCCUQXuHABxCAYXSC6wIUTiC7wFgL4MPveTaj9optrO+696ya8yeQRQFRAdIEYAxoVBD/PNtdCwHWpDIJwr+1PMCk1DgAkCSx/jHrLsv/p+lfKAp3HzQOYDAqxKtcYBJPtXe/B1Y3TXgmATGst0WIrgAC7JmBINOQsNN8HE0zfVQFlFxzrgFgHNLQOkNJuQ7vrcgkS1CXEua5fgnDj+l+172CX/h59Tbn9Of0qBUE1cGe2ngPhLWeiEH0krFDBT63HC8Cnx/VtFuFDfgl90UOldDvuX4WcSo7lBSD0YuR4H6ebZwRNkRUw9xdSah1G+IzZmW5IW7ERDX/e9Rc+YwerBEMvQo1nrhfqkf/ZuYCxxK5J/t4AjkFQBi71CXxFoFSWq2XTlkn+AndXodNf5SwgT4J7gnttoNL6BqUEmCZET/tkvzQZYj5g1Sf/0goIkfcJYIkEK5HsFnkYnen6BXQptUb5lwJgMz4zCihXD/BqAwVDuoy+Uqx399kACrkZaYECVjY5qxJZXpoQwrcDHB6UghfVvPssAMo35W4R7oZVg5EMmAJxUCZ2CNzfVJ2Pm6qdleDBNwFClaHZdRrQAEhWe25VSPCuAMo1tnQhdIzMNUixfDYBqAOGVQEKQB15OFMCwXPV3QsFww7g73E39Pudr/Gn0EyplQPXCkBF/5AKsBtPKRA+AdKAEx/0BhYLL9nHFkhZLiBvbkOcxFzG5wPtoe7gBUrrTiMttqO+8ebZCkAtWErs17jHvrrSLcj+lkCpKeV5g/ABIA05lqgVM4Er2nPhZgev7DHGnToLG+ALIC9budgWwoRzyuMUPlzj8waVBuELIFOB5iksi7xIKQh8PS4wu8/j+a3vBScbRAgABVfg5BZbH6SFgP0kVIl7UCjNja4RCkAGwecaPLDhp4yNsSYkADlp/mncdNLLu8fpud9XQK7//wERGoBrAefSfgRBsLI9pTtPg+diUNV1yLuJypVg1Un/p/8arwDXZkQALkJNb48KaPoOu+yLCnARanp7VEDTd9hlX1SAi1DT2/8AaakVXysj5qkAAAAASUVORK5CYII="},originalRroviders:["wxpay","alipay"],currentProviders:["wxpay","alipay"],openid:""}),async mounted(){let e,t;r||(e=await this.getCode(),t=await this.getOpenid({provider:"wxpay",code:e}),t&&(r=t.openid,this.openid=t.openid)),this.originalRroviders=["wxpay"],this.currentProviders=JSON.parse(JSON.stringify(this.originalRroviders)),this.$emit("mounted",{images:this.images,originalRroviders:this.originalRroviders,currentProviders:this.currentProviders})},methods:{async open(e={}){if(e.provider){let t=[];this.originalRroviders.map(((i,r)=>{e.provider.indexOf(i)>-1&&t.push(i)})),this.currentProviders=t,delete e.provider}else this.currentProviders=JSON.parse(JSON.stringify(this.originalRroviders));this.options=e,1===this.currentProviders.length?this.createOrder({provider:this.currentProviders[0]}):("pc"===this.modeCom&&this._pcChooseProvider(this.currentProviders[0]),this.openPopup("payPopup"))},async createOrder(e={}){let{options:t}=this;if(Object.assign(t,e),"appleiap"===t.provider)return this._appleiapCreateOrder(t);let o={provider:t.provider,total_fee:t.total_fee,openid:r,order_no:t.order_no,out_trade_no:t.out_trade_no,description:t.description,type:t.type,qr_code:t.qr_code,custom:t.custom,other:t.other,wxpay_virtual:t.wxpay_virtual};r&&(o.openid=r);try{let e=await i.createOrder(o);e.errCode?this.$emit("fail",e):(this.$emit("create",e),e.qr_code&&!t.cancel_popup?(this.res=e,"pc"===this.modeCom?(this.openPopup("payPopup"),this._pcChooseProvider(t.provider)):this.openPopup("qrcodePopup")):this.orderPayment(e))}catch(a){this.$emit("fail",a)}},orderPayment(t){this.res=t,t.qr_code?this.$emit("qrcode",t):t.order&&("wxpay-virtual"===t.provider?e.index.requestVirtualPayment({...t.order,success:e=>{this._getOrder()},fail:e=>{-1==e.errMsg.indexOf("fail cancel")?(console.error("uni.requestVirtualPayment:fail",e),this.$emit("fail",e)):this.$emit("cancel",e)}}):e.index.requestPayment({...t.order,...t.order,success:e=>{this._getOrder()},fail:e=>{-1==e.errMsg.indexOf("fail cancel")?(console.error("uni.requestPayment:fail",e),this.$emit("fail",e)):this.$emit("cancel",e)}}))},openPopup(e){this.$refs[e].showPopup||this.$refs[e].open()},closePopup(e){this.$refs[e].close()},async getOrder(e={}){try{let t=await i.getOrder(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async refund(e={}){try{let t=await i.refund(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async getRefund(e={}){try{let t=await i.getRefund(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async closeOrder(e={}){try{let t=await i.closeOrder(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async getPayProviderFromCloud(e={}){try{let t=await i.getPayProviderFromCloud(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async getProviderAppId(e={}){try{let t=await i.getProviderAppId(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async getOpenid(e={}){try{let t=await i.getOpenid(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},async verifyReceiptFromAppleiap(e={}){try{let t=await i.verifyReceiptFromAppleiap(e);return"function"==typeof e.success&&e.success(t),t}catch(t){"function"==typeof e.fail&&e.fail(t)}},getCode:async()=>t.util.getWeixinCode(),paySuccess(e={}){this.closePopup("payPopup"),this.closePopup("payConfirmPopup"),this.clearQrcode(),this.toSuccessPage&&this.pageToSuccess(e),this.$emit("success",e)},pageToSuccess(t){if("pc"!==this.modeCom)e.index.navigateTo({url:`/uni_modules/uni-pay/pages/success/success?out_trade_no=${t.out_trade_no}&order_no=${t.pay_order.order_no}&pay_date=${t.pay_order.pay_date}&total_fee=${t.pay_order.total_fee}&adpid=${this.adpid}&return_url=${this.returnUrl}&main_color=${this.mainColor}`});else if(this.returnUrl){let i=this.returnUrl+`?out_trade_no=${t.out_trade_no}&order_no=${t.pay_order.order_no}`;0!==i.indexOf("/")&&(i=`/${i}`),e.index.navigateTo({url:i})}},clearQrcode(){this.res.codeUrl="",this.res.qr_code_image=""},async _getOrder(){this.getOrder({out_trade_no:this.res.out_trade_no,await_notify:!0,success:e=>{e.has_paid&&(this.closePopup("qrcodePopup"),this.paySuccess(e))}})},_afreshPayment(){this.orderPayment(this.res)},_pcChooseProvider(e){if(e!==this.options.provider)return this.createOrder({provider:e})},async _appleiapCreateOrder(t){let r=new appleiapSdk.Iap({products:[t.productid]});e.index.showLoading({title:"加载中..."}),await r.init();let o=(await r.getProduct())[0];t.total_fee=100*o.price,t.description=o.description;let a={provider:t.provider,total_fee:t.total_fee,order_no:t.order_no,out_trade_no:t.out_trade_no,description:t.description,type:t.type,custom:t.custom},n=await i.createOrder(a);if(0===n.errCode){this.$emit("create",n),this.res=n,e.index.showLoading({title:"支付请求中..."});try{this.debug&&console.log("正在请求苹果服务器",t.productid,n.out_trade_no);let i=await r.requestPayment({productid:t.productid,username:n.out_trade_no});if(this.debug&&console.log("用户支付成功",i),e.index.showLoading({title:"正在处理支付结果..."}),i.payment.username||(i.payment.username=this.getAppleiapUserName(i)),!i.payment.username)return await r.finishTransaction(i),e.index.hideLoading(),console.log("您可能已支付成功，但很抱歉丢单了，请联系客服处理。",i),!1;this.addAppleiapOrder(i);let o=await this.verifyReceiptFromAppleiap({out_trade_no:i.payment.username,transaction_receipt:i.transactionReceipt,transaction_identifier:i.transactionIdentifier});0===o.errCode&&(await r.finishTransaction(i),this.removeAppleiapOrder(i),e.index.hideLoading(),this.paySuccess(o))}catch(s){2===(s.errCode||s.code)?(this.debug&&console.log("用户取消支付"),this.$emit("cancel",s)):(console.error("appleiapCreateOrder:fail",s),this.$emit("fail",s)),e.index.hideLoading()}}},async appleiapRestore(){e.index.showLoading({title:"检测支付环境..."});let t=new appleiapSdk.Iap;await t.init();try{this.debug&&console.log("正在查询是否有漏单信息");const i=await t.restoreCompletedTransactions({username:""});if(this.debug&&console.log("漏单查询结果："+(0===i.length?"未漏单":"有漏单"),i),!i.length)return;for(let e=0;e<i.length;e++){let r=i[e];switch(r.transactionState){case appleiapSdk.IapTransactionState.purchased:if(r.payment.username||(r.payment.username=this.getAppleiapUserName(r)),!r.payment.username){await t.finishTransaction(r),console.log("您可能已支付成功，但很抱歉丢单了，请联系客服处理。",r);continue}console.log("requestPaymentRes: ",r);let e=await this.verifyReceiptFromAppleiap({out_trade_no:r.payment.username,transaction_receipt:r.transactionReceipt,transaction_identifier:r.transactionIdentifier});console.log("verifyRes: ",e),0===e.errCode&&(console.log("完结订单："+r.payment.username),await t.finishTransaction(r),this.removeAppleiapOrder(r));break;case appleiapSdk.IapTransactionState.failed:await t.finishTransaction(r)}}}catch(i){console.error(i)}finally{e.index.hideLoading()}},addAppleiapOrder(t){let i="uni-pay-appleiap-order",r=e.index.getStorageSync(i)||[];r.push(t),e.index.setStorageSync(i,r)},getAppleiapUserName(t){let i=(e.index.getStorageSync("uni-pay-appleiap-order")||[]).find((e=>e.transactionIdentifier===t.transactionIdentifier&&e.transactionDate===t.transactionDate));return i&&i.payment&&i.payment.username},removeAppleiapOrder(t){let i="uni-pay-appleiap-order",r=e.index.getStorageSync(i)||[],o=r.findIndex((e=>e.transactionIdentifier===t.transactionIdentifier&&e.transactionDate===t.transactionDate));o>-1&&r.splice(o,1),e.index.setStorageSync(i,r)}},watch:{},computed:{modeCom(){if(this.mode)return this.mode;let t=e.index.getSystemInfoSync();return t&&"pc"===t.deviceType?"pc":"mobile"}}};if(!Array){(e.resolveComponent("uni-popup")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list"))()}Math||((()=>"../../../uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../../uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../uni-list/components/uni-list/uni-list.js"))();const a=e._export_sfc(o,[["render",function(t,i,r,o,a,n){return e.e({a:"pc"===n.modeCom},"pc"===n.modeCom?e.e({b:a.res.qr_code_image,c:e.t((a.options.total_fee/100).toFixed(2)),d:a.res.qr_code_image},a.res.qr_code_image?{e:e.o((e=>n._getOrder()))}:{},{f:a.currentProviders.indexOf("wxpay")>-1},a.currentProviders.indexOf("wxpay")>-1?{g:a.images.wxpay,h:e.n("wxpay"==a.options.provider?"active":""),i:e.o((e=>n._pcChooseProvider("wxpay")))}:{},{j:a.currentProviders.indexOf("alipay")>-1},a.currentProviders.indexOf("alipay")>-1?{k:a.images.alipay,l:e.n("alipay"==a.options.provider?"active":""),m:e.o((e=>n._pcChooseProvider("alipay")))}:{},{n:r.logo,o:e.sr("payPopup","1e2c5faf-0"),p:e.p({type:"center","safe-area":!1})}):e.e({q:e.t((a.options.total_fee/100).toFixed(2)),r:a.currentProviders.indexOf("wxpay")>-1},a.currentProviders.indexOf("wxpay")>-1?{s:e.o((e=>n.createOrder({provider:"wxpay"}))),t:e.p({thumb:a.images.wxpay,title:"微信支付",clickable:!0,link:!0})}:{},{v:e.s("min-height: "+r.height+";"),w:e.sr("payPopup","1e2c5faf-1"),x:e.p({type:"bottom","safe-area":!1})}),{y:a.res.qr_code_image,z:e.t((a.options.total_fee/100).toFixed(2)),A:"wxpay"==a.options.provider},("wxpay"==a.options.provider||a.options.provider,{}),{B:"alipay"==a.options.provider,C:e.o((e=>n._getOrder())),D:e.o((e=>n.closePopup("qrcodePopup"))),E:e.sr("qrcodePopup","1e2c5faf-4"),F:e.o(n.clearQrcode),G:e.p({type:"center","safe-area":!1,animation:!1,"mask-click":!1}),H:e.o((e=>n._getOrder())),I:e.o((e=>n._afreshPayment())),J:e.o((e=>n.closePopup("payConfirmPopup"))),K:e.sr("payConfirmPopup","1e2c5faf-5"),L:e.p({type:"center","safe-area":!1,animation:!1,"mask-click":!1})})}],["__scopeId","data-v-1e2c5faf"]]);wx.createComponent(a);
