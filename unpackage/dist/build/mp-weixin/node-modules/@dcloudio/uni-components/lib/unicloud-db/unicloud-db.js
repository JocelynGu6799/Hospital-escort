"use strict";const t=require("../../../../../common/vendor.js"),e=Array.isArray,{t:i}=t.initVueI18n(t.messages),n="load",a="error",o="add",s="replace",r="auto",l="manual",c=["pageCurrent","pageSize","collection","action","field","getcount","orderby","where","groupby","groupField","distinct"],h={name:"UniClouddb",setup(e){const i=e.ssrKey?e.getone?t.shallowSsrRef(void 0,e.ssrKey):t.ssrRef([],e.ssrKey):e.getone?t.shallowSsrRef(void 0,"spEwSynBqf2mUAPrsKcO2A=="):t.ssrRef([],"2PxqBST8nbTMGh5yMNt8dA=="),n=t.getCurrentInstance();return t.onMounted((()=>{i.value&&0!==i.value.length||e.manual||e.loadtime!==r||n.proxy.loadData()})),{dataList:i}},async serverPrefetch(){if(!this.manual&&this.loadtime===r)return this.loadData()},props:{options:{type:[Object,Array],default:()=>({})},spaceInfo:{type:Object,default:()=>({})},collection:{type:[String,Array],default:""},action:{type:String,default:""},field:{type:String,default:""},orderby:{type:String,default:""},where:{type:[String,Object],default:""},pageData:{type:String,default:"add"},pageCurrent:{type:Number,default:1},pageSize:{type:Number,default:20},getcount:{type:[Boolean,String],default:!1},getone:{type:[Boolean,String],default:!1},gettree:{type:[Boolean,String,Object],default:!1},gettreepath:{type:[Boolean,String],default:!1},startwith:{type:String,default:""},limitlevel:{type:Number,default:10},groupby:{type:String,default:""},groupField:{type:String,default:""},distinct:{type:[Boolean,String],default:!1},pageIndistinct:{type:[Boolean,String],default:!1},foreignKey:{type:String,default:""},loadtime:{type:String,default:"auto"},manual:{type:Boolean,default:!1},ssrKey:{type:[String,Number],default:""}},data:()=>({loading:!1,hasMore:!1,paginationInternal:{},errorMessage:""}),computed:{collectionArgs(){return e(this.collection)?this.collection:[this.collection]},isLookup(){return e(this.collection)&&this.collection.length>1||"string"==typeof this.collection&&this.collection.indexOf(",")>-1},mainCollection(){if("string"==typeof this.collection)return this.collection.split(",")[0];return JSON.parse(JSON.stringify(this.collection[0])).$db[0].$param[0]}},created(){this._isEnded=!1,this.paginationInternal={current:this.pageCurrent,size:this.pageSize,count:0},this.$watch((()=>{var t=[];return c.forEach((e=>{t.push(this[e])})),t}),((t,e)=>{if(this.paginationInternal.size=this.pageSize,t[0]!==e[0]&&(this.paginationInternal.current=this.pageCurrent),this.loadtime===l)return;let i=!1;for(let n=2;n<t.length;n++)if(t[n]!==e[n]){i=!0;break}i&&(this.clear(),this.reset()),this._execLoadData()}))},methods:{loadData(t,e){let i=null,n=!1;return"object"==typeof t?(t.clear&&(this.pageData===s?this.clear():n=t.clear,this.reset()),void 0!==t.current&&(this.paginationInternal.current=t.current),"function"==typeof e&&(i=e)):"function"==typeof t&&(i=t),this._execLoadData(i,n)},loadMore(){this._isEnded||this.loading||(this.pageData===o&&this.paginationInternal.current++,this._execLoadData())},refresh(){this.clear(),this._execLoadData()},clear(){this._isEnded=!1,this.dataList=[]},reset(){this.paginationInternal.current=1},add(e,{action:n,showToast:a=!0,toastTitle:o,success:s,fail:r,complete:l,needConfirm:c=!0,needLoading:h=!0,loadingTitle:d=""}={}){h&&t.index.showLoading({title:d});let g=t.Ws.database(this.spaceInfo);n&&(g=g.action(n)),g.collection(this.mainCollection).add(e).then((e=>{s&&s(e),a&&t.index.showToast({title:o||i("uniCloud.component.add.success")})})).catch((e=>{r&&r(e),c&&t.index.showModal({content:e.message,showCancel:!1})})).finally((()=>{h&&t.index.hideLoading(),l&&l()}))},remove(e,{action:n,success:a,fail:o,complete:s,confirmTitle:r,confirmContent:l,needConfirm:c=!0,needLoading:h=!0,loadingTitle:d=""}={}){e&&e.length&&(c?t.index.showModal({title:r||i("uniCloud.component.remove.showModal.title"),content:l||i("uniCloud.component.remove.showModal.content"),showCancel:!0,success:t=>{t.confirm&&this._execRemove(e,n,a,o,s,c,h,d)}}):this._execRemove(e,n,a,o,s,c,h,d))},update(e,n,{action:a,showToast:o=!0,toastTitle:s,success:r,fail:l,complete:c,needConfirm:h=!0,needLoading:d=!0,loadingTitle:g=""}={}){d&&t.index.showLoading({title:g});let u=t.Ws.database(this.spaceInfo);return a&&(u=u.action(a)),u.collection(this.mainCollection).doc(e).update(n).then((e=>{r&&r(e),o&&t.index.showToast({title:s||i("uniCloud.component.update.success")})})).catch((e=>{l&&l(e),h&&t.index.showModal({content:e.message,showCancel:!1})})).finally((()=>{d&&t.index.hideLoading(),c&&c()}))},getTemp(e=!0){let i=t.Ws.database(this.spaceInfo);this.action&&(i=i.action(this.action)),i=i.collection(...this.collectionArgs),this.foreignKey&&(i=i.foreignKey(this.foreignKey)),this.where&&Object.keys(this.where).length&&(i=i.where(this.where)),this.field&&(i=i.field(this.field)),this.groupby&&(i=i.groupBy(this.groupby)),this.groupField&&(i=i.groupField(this.groupField)),!0===this.distinct&&(i=i.distinct()),this.orderby&&(i=i.orderBy(this.orderby));const{current:n,size:a}=this.paginationInternal,o={};this.getcount&&(o.getCount=this.getcount);const s={limitLevel:this.limitlevel,startWith:this.startwith};return this.gettree&&(o.getTree=s),this.gettreepath&&(o.getTreePath=s),i=i.skip(a*(n-1)).limit(a),e?(i=i.getTemp(o),i.udb=this):i=i.get(o),i},setResult(t){0===t.code?this._execLoadDataSuccess(t):this._execLoadDataFail(new Error(t.message))},_execLoadData(t,e){if(!this.loading)return this.loading=!0,this.errorMessage="",this._getExec().then((i=>{this.loading=!1,this._execLoadDataSuccess(i.result,t,e)})).catch((e=>{this.loading=!1,this._execLoadDataFail(e,t)}))},_execLoadDataSuccess(t,e,i){const{data:a,count:o}=t;this._isEnded=void 0!==o?this.paginationInternal.current*this.paginationInternal.size>=o:a.length<this.pageSize,this.hasMore=!this._isEnded;const r=this.getone?a.length?a[0]:void 0:a;this.getcount&&(this.paginationInternal.count=o),e&&e(r,this._isEnded,this.paginationInternal),this._dispatchEvent(n,r),this.getone||this.pageData===s||i?this.dataList=r:this.dataList.push(...r)},_execLoadDataFail(t,e){this.errorMessage=t,e&&e(),this.$emit(a,t)},_getExec(){return this.getTemp(!1)},_execRemove(i,n,a,o,r,l,c,h){if(!this.collection||!i)return;const d=e(i)?i:[i];if(!d.length)return;c&&t.index.showLoading({mask:!0,title:h});const g=t.Ws.database(this.spaceInfo),u=g.command;let p=g;n&&(p=p.action(n)),p.collection(this.mainCollection).where({_id:u.in(d)}).remove().then((t=>{a&&a(t.result),this.pageData===s?this.refresh():this.removeData(d)})).catch((e=>{o&&o(e),l&&t.index.showModal({content:e.message,showCancel:!1})})).finally((()=>{c&&t.index.hideLoading(),r&&r()}))},removeData(t){const e=t.slice(0),i=this.dataList;for(let n=i.length-1;n>=0;n--){const t=e.indexOf(i[n]._id);t>=0&&(i.splice(n,1),e.splice(t,1))}},_dispatchEvent(t,e){this._changeDataFunction?this._changeDataFunction(e,this._isEnded,this.paginationInternal):this.$emit(t,e,this._isEnded,this.paginationInternal)}}};const d=t._export_sfc(h,[["render",function(e,i,n,a,o,s){return{a:t.r("d",{options:n.options,data:a.dataList,pagination:o.paginationInternal,loading:o.loading,hasMore:o.hasMore,error:o.errorMessage})}}]]);wx.createComponent(d);
